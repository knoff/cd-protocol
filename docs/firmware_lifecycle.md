# Жизненный цикл прошивки и режимы работы

**Версия:** 1.0 (Draft)
**Статус:** Concept

Документ описывает стратегию управления состоянием узлов, процедуру OTA-обновлений и сервисные режимы.

---

## 1. Режимы работы (System Modes)

Узел (ESP32) может находиться в одном из взаимоисключающих состояний.

### 1.1. Active Mode (ESP-NOW)

Штатный режим работы.

- **Транспорт:** ESP-NOW (Low Latency).
- **WiFi:** Выключен (Radio OFF) для экономии энергии и снижения шума.
- **Функции:** Исполнение профилей варки, чтение датчиков.

### 1.2. Maintenance Mode (WiFi Station)

Сервисный режим для обновлений и глубокой отладки.

- **Транспорт:** WiFi Station (подключение к AP на RPi).
- **ESP-NOW:** Приостановлен (или работает в режиме Time Slicing).
- **Функции:**
  - OTA Update (HTTP/HTTPS).
  - Telnet/WebSocket (Remote Shell "ADB").
  - Выгрузка Crash logs.
- **Вход:** Команда `CMD_SYS_MODE_SWITCH { Mode: WIFI, Creds: ... }`.
- **Выход:** Команда по WiFi, таймаут отсутствия активности (300 сек) или перезагрузка.

### 1.3. Safe Mode (Recovery)

Аварийный режим после сбоя или неудачного обновления.

- **Индикация:** Специфический паттерн LED (SOS).
- **Действия:** Ожидание ручного вмешательства или команды отката.

---

## 2. Стратегия OTA обновлений (Atomic Fleet Update)

Так как система является замкнутым контуром, версии прошивок всех узлов и RPi должны быть синхронизированы.

### 2.1. Алгоритм "Волна" (Wave Update)

Включение WiFi на всех устройствах внутри металлического корпуса одновременно приведет к коллапсу сети. Обновление производится группами.

1. **Подготовка:** RPi проверяет наличие файлов прошивок.
2. **Группа 1:** RPi переводит 2-3 устройства в _Maintenance Mode_.
3. **Обновление:** Устройства скачивают образы, проверяют CRC.
4. **Ожидание:** Устройства перезагружаются в новый раздел, но **не активируют** его как основной (Pending Verify).
5. **Повторение:** RPi берет следующую группу.

### 2.2. Синхронный Commit или Rollback

После того как все устройства прошиты и перезагрузились:

1. RPi опрашивает сеть: "Все ли онлайн с новой версией?".
2. **Успех:** RPi шлет команду `CMD_SYS_OTA_COMMIT`. Устройства помечают раздел как Valid.
3. **Сбой:** Если хотя бы одно критическое устройство не вышло на связь, RPi шлет `CMD_SYS_OTA_ROLLBACK` (или устройства откатываются сами по таймауту Watchdog).

---

## 3. Boot & Validation (Защита от окирпичивания)

Процедура старта ESP32 должна учитывать, что RPi может загружаться дольше.

### Логика подтверждения запуска (Boot Validation)

1. **Power On.** Загрузка из активного раздела.
2. **Self-Test (Hardware):** Проверка периферии (I2C, GPIO).
   - _Fail:_ Перезагрузка. Счетчик сбоев ++.
3. **Tentative State (Испытательный срок):**
   - Устройство работает, выполняет функции.
   - Раздел еще **не помечен** как Valid.
   - Запускается таймер (например, 120 сек).
4. **Validation Criteria:**
   - **Вариант А (Связь):** Получен пакет от RPi (Time Sync или Ping). -> `mark_app_valid()`.
   - **Вариант Б (Таймер):** Если за 120 сек не произошло Panic/WDT Reset. -> `mark_app_valid()`.

---

## 4. CD-ADB (Remote Debugging)

Инструмент для прозрачной диагностики (аналог Android ADB).

### Интерфейсы

1. **Serial (UART):** Прямое подключение при производстве.
2. **Network (Tunnel):**
   - В режиме Active: Инкапсуляция текста в пакеты ESP-NOW (`CMD_DEBUG_EXEC`).
   - В режиме Maintenance: Telnet/TCP сокет.

### Протокол

Текстовые команды поверх транспорта.

- `> sensor list` -> Список сенсоров.
- `> gpio set 12 1` -> Прямое управление (только в Factory Mode).
- `> log dump` -> Выгрузка буфера ошибок.
- `> nvs print` -> Просмотр конфигурации.
