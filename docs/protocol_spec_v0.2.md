# Спецификация протокола CD-BUS v0.2.0

**Статус:** Draft / Experimental
**Дата:** 17.12.2025
**Транспорт:** ESP-NOW (802.11 Action Frames)

## 1. Концепция

Система представляет собой распределенную сеть управления (DCS), работающую внутри экранированного корпуса.
RPi выступает в роли Оркестратора и Шлюза, но не является прямым звеном в петле управления реального времени (RT).

### Основные принципы

1. **JIT Profiles:** Профили экстракции передаются потоково. Исполнители хранят буфер только на несколько секунд вперед.
2. **Vector State:** Управление идет не по одному параметру, а вектором `{Время, Температура, Давление, Поток}` с флагом приоритета.
3. **Event Driven UI:** Органы управления (кнопки, ручки) являются "слепыми" источниками событий. Логика реакции определяется RPi.
4. **Haptic Feedback:** Ручки управления имеют программно-изменяемую физику (отдача, щелчки, упоры).

---

## 2. Типы Устройств и Роли

### 2.1. Датчики (Sensors Array)

Устройства, транслирующие физические параметры.

- **Примеры:** Термопары бойлеров, датчики уровня.
- **Поведение:**
  - В покое: Низкая частота опроса (1 Гц) для мониторинга.
  - В работе: Высокая частота (10-20 Гц) для PID и сбора данных "Энергии".
  - Пакеты могут объединять данные нескольких сенсоров (`DATA_MULTI`).

### 2.2. Умные Весы (Gravimetric Sensor)

Ключевой элемент обратной связи.

- **Функция:** Измерение веса и вычисление **выходного потока** (производной массы).
- **События:**
  - `EVENT_FLOW_START`: Детекция "первой капли" (начало реальной экстракции).
  - `EVENT_TARGET_REACHED`: Достижение целевого веса (триггер остановки).
- **Особенности:** Используют встроенный цифровой фильтр вибраций помпы.

### 2.3. Исполнители (Smart Actuators)

- **Помпа (Pump):** \* Управляется по **Потоку (мл/сек)**, а не просто мощностью.
  - Имеет таблицу калибровки "Обороты -> Объем".
- **Нагреватели (Heaters):**
  - Получают уставку температуры (Target Temp).
  - Сами реализуют PID-регулирование.
  - Передают обратно `%` мощности (Duty Cycle) для расчета энергии.

### 2.4. Haptic Interface (Ручки с экранами)

Уникальный узел взаимодействия.

- **Ввод:** Вращение энкодера, нажатие.
- **Вывод (Экран):** Отображает виджеты по команде RPi (не рендерит графику сам).
- **Вывод (Тактильный):**
  - _Mode Free:_ Свободное вращение.
  - _Mode Detents:_ Виртуальные щелчки (для меню).
  - _Mode Spring:_ Пружинный возврат (для ручного профилирования давления).
  - _Mode Servo:_ Принудительное вращение мотором (автоматизация).

### 2.5. Простые UI (Buttons/Levers)

- Транслируют сырые события: `CLICK_SHORT`, `HOLD_START`, `LEVER_POSITION`.
- Индикация (LED) управляется командами от RPi.

---

## 3. Модель Управления (Profiles)

Управление процессом варки происходит через сообщение `CMD_PROFILE_STEP`.
Каждый шаг профиля содержит вектор целей. Так как гидравлически невозможно одновременно гарантировать и Поток, и Давление, используется **Приоритет**.

| Режим               | Описание                                                    | Применение                         |
| :------------------ | :---------------------------------------------------------- | :--------------------------------- |
| `PRIORITY_FLOW`     | Помпа держит заданный поток любой ценой. Давление вторично. | Предсмачивание, заполнение группы. |
| `PRIORITY_PRESSURE` | Система стремится удержать давление. Поток подстраивается.  | Классическая экстракция (9 бар).   |
| `PRIORITY_HYBRID`   | Экспериментальный режим для R&D (баланс энергии).           | Исследование вкуса.                |

---

## 4. Маршрутизация

- **Топология:** Mesh с ограничением в 1 хоп.
- **Адресация:** Логические ID (`HU_DEV_xxx`).
- **Таблица:** Статическая. Загружается при старте или калибровке.
