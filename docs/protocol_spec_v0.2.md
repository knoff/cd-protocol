# Спецификация протокола CD-BUS v0.2.3

**Статус:** Draft / Experimental
**Дата:** 18.12.2025
**Версия:** 0.2.3 (Compact Nodes & Dynamic Addressing)
**Транспорт:** ESP-NOW (802.11 Action Frames)

## 1. Концепция

Система представляет собой распределенную сеть управления (DCS), работающую внутри экранированного корпуса.
Ключевая особенность — переход от последовательных команд к **Векторному Профилированию** с аппроксимацией.

### Основные принципы

1. **Keyframe Profiling:** RPi отправляет не поток команд реального времени, а пакет с ключевыми точками ("кадрами") профиля. Узлы сами интерполируют значения между ними.
2. **5D Control Vector:** Управление ведется по 5 осям: `{Время, T, P, Flow_In, Flow_Out, Energy}`.
3. **Safety Corridors:** Вместо жестких уставок используются "Коридоры" (`Target ± Tolerance`). Это позволяет PID-регулятору гибко жертвовать второстепенными параметрами ради удержания Приоритета.
4. **Dynamic Provisioning:** Устройства не имеют жестко зашитых адресов. Роли распределяются RPi при инициализации.

---

## 2. Типы Устройств и Роли

### 2.1. Датчики (Sensors Array)

Устройства, транслирующие физические параметры.

- **Примеры:** Термопары бойлеров, датчики уровня.
- **Поведение:**
  - В покое: Низкая частота опроса (1 Гц) для мониторинга.
  - В работе: Высокая частота (10-20 Гц) для PID и сбора данных "Энергии".
  - Пакеты могут объединять данные нескольких сенсоров (`DATA_MULTI`).

### 2.2. Умные Весы (Gravimetric Sensor)

Ключевой элемент обратной связи.

- **Функция:** Измерение веса и вычисление **выходного потока** (производной массы).
- **События:**
  - `EVENT_FLOW_START`: Детекция "первой капли" (начало реальной экстракции).
  - `EVENT_TARGET_REACHED`: Достижение целевого веса (триггер остановки).
- **Особенности:** Используют встроенный цифровой фильтр вибраций помпы.

### 2.3. Исполнители (Smart Actuators)

- **Помпа (Pump):** \* Управляется по **Потоку (мл/сек)**, а не просто мощностью.
  - Имеет таблицу калибровки "Обороты -> Объем".
- **Нагреватели (Heaters):**
  - Получают уставку температуры (Target Temp).
  - Сами реализуют PID-регулирование.
  - Передают обратно `%` мощности (Duty Cycle) для расчета энергии.

### 2.4. Haptic Interface (Ручки с экранами)

Уникальный узел взаимодействия.

- **Ввод:** Вращение энкодера, нажатие.
- **Вывод (Экран):** Отображает виджеты по команде RPi (не рендерит графику сам).
- **Вывод (Тактильный):**
  - _Mode Free:_ Свободное вращение.
  - _Mode Detents:_ Виртуальные щелчки (для меню).
  - _Mode Spring:_ Пружинный возврат (для ручного профилирования давления).
  - _Mode Servo:_ Принудительное вращение мотором (автоматизация).

### 2.5. Простые UI (Buttons/Levers)

- Транслируют сырые события: `CLICK_SHORT`, `HOLD_START`, `LEVER_POSITION`.
- Индикация (LED) управляется командами от RPi.

---

## 3. Модель Управления (Profiles)

Управление процессом варки происходит через сообщение `CMD_PROFILE_LOAD`.
Каждый шаг профиля содержит вектор целей. Так как гидравлически невозможно одновременно гарантировать и Поток, и Давление, используется **Приоритет**.

### Control

- `CMD_PROFILE_LOAD`: Загрузка чанка профиля (массив Compact Nodes).
- `CMD_SET_STATE`: Прямое управление (вкл/выкл) для тестов/промывки.
- `CMD_HAPTIC_CFG`: Настройка физики ручек (Пружина, Упоры, Щелчки).
- `CMD_UI_WIDGET`: Отрисовка элемента на экране энкодера.

### Telemetry & Events

- `DATA_SCALE`: Вес + Вычисленный поток (`mg/s`).
- `EVENT_FLOW_START`: Детекция первой капли (синхронизация T0).
- `EVENT_CRITICAL`: Аварийный останов (Broadcast).

---

## 4. Маршрутизация

- **Топология:** Mesh с ограничением в 1 хоп.
- **Адресация:** Логические ID (`HU_DEV_xxx`).
- **Таблица:** Статическая. Загружается при старте или калибровке.

## 5. Адресация и Регистрация (Provisioning)

Протокол разделяет понятие **Типа устройства** (зашито в прошивку) и **Логического Адреса** (назначается RPi).

### 5.1. Адресное пространство

- `0x01`: **Coordinator** (RPi).
- `0xFE`: **Unassigned**. Адрес по умолчанию для новых устройств.
- `0xFF`: **Broadcast**. Всем.
- `0x10 .. 0xF0`: **Dynamic IDs**. Рабочий диапазон адресов узлов.
- `0x02 .. 0x09`, `0xF1 .. 0xFD`: **RESERVED**. Зарезервировано.

### 5.2. Процедура Discovery (Поиск)

Используется для обнаружения устройств и их инвентаризации.

1. **RPi** посылает `SYS_DISCOVERY_REQ` (Broadcast).
2. **Все узлы** отвечают `SYS_DISCOVERY_RES` с задержкой (random jitter 0..100ms), чтобы избежать коллизий.
3. **Payload ответа:** `{ DeviceType, HW_Rev, FW_Ver, Current_ID }`.

### 5.3. Процедура Assign ID (Назначение)

Используется для привязки физического устройства к логической роли.

1. **RPi** формирует пакет `SYS_ASSIGN_ID`.
2. **Payload:** `{ Target_MAC[6], New_ID }`.
3. **RPi** отправляет пакет на адрес `0xFF` (Broadcast) или `0xFE` (Unassigned).
4. **Узел** сверяет `Target_MAC` в пакете со своим собственным.
   - Если совпадает: Сохраняет `New_ID` в NVS (Non-Volatile Storage) и перезагружается.
   - Если не совпадает: Игнорирует.

### 5.4. Пример жизненного цикла

1. Установлено 2 одинаковых бойлера (Type `BOILER_PID`). Оба имеют адрес `0xFE`.
2. Инженер через UI запускает "Поиск". RPi видит два MAC-адреса: `...AA` и `...BB`.
3. Инженер отправляет команду "Идентифицировать `...AA`" (Узел мигает светодиодом).
4. Инженер назначает: "Это Бойлер Кофе".
5. RPi шлет `ASSIGN_ID` (`Target=...AA`, `ID=0x10`).
6. Теперь RPi знает, что `0x10` — это левый бойлер, и шлет ему профили.

## 6. Физическая Модель (Compact Profile Nodes)

Для экономии трафика и увеличения автономности (до 17 узлов в одном пакете 230 байт) используется сжатие данных. Значения передаются как `uint8` с масштабирующими коэффициентами.

### 6.1. Единицы измерения и Диапазоны

| Параметр              | LSB (Цена деления) | Диапазон (uint8)  | Пример (Raw=Val) |
| :-------------------- | :----------------- | :---------------- | :--------------- |
| **Температура (T)**   | **0.5 °C**         | 0.0 ... 127.5 °C  | 187 = 93.5 °C    |
| **Давление (P)**      | **0.1 Bar**        | 0.0 ... 25.5 Bar  | 90 = 9.0 Bar     |
| **Flow In (Pump)**    | **0.1 ml/s**       | 0.0 ... 25.5 ml/s | 25 = 2.5 ml/s    |
| **Flow Out (Scales)** | **0.1 ml/s**       | 0.0 ... 25.5 ml/s | 15 = 1.5 ml/s    |
| **Энергия (E)**       | **1 Unit**         | 0 ... 255 Units   | Index            |

### 6.2. Приоритеты (Conflict Resolution)

В каждом узле задается флаг `Priority`, определяющий стратегию PID-регулятора при выходе значений за пределы `Tolerance`.

1. **PRIORITY_FLOW_IN (Pump):** "Дави заданный объем". Давление вторично. (Предсмачивание).
2. **PRIORITY_PRESSURE:** "Держи давление". Помпа меняет обороты, чтобы попасть в P. (Классика).
3. **PRIORITY_FLOW_OUT (Gravimetric):** "Держи поток в чашку". Помпа подстраивает входной поток, компенсируя сопротивление таблетки. (Adaptive Profiling).
4. **PRIORITY_ENERGY:** Экспериментальный режим. Удержание интегрального показателя мощности.

### 6.3. Интерполяция

Узлы содержат флаг `Interpolation`:

- **LINEAR (0):** Линейный переход к следующей точке.
- **SPLINE (1):** Сглаженная кривая (избегает резких рывков помпы).
- **STEP (2):** Мгновенное изменение (Hold).
